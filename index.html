<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leave Request System</title>
  <style>
    :root{ --primary:#6C63FF; --secondary:#FF6584; --bg:#f9f9fb; --card:#fff; --text:#2c3e50; }
    *{box-sizing:border-box}
    body{ font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif; margin:20px; background:var(--bg); color:var(--text); }
    h1{ text-align:center; margin-bottom:20px; font-size:28px; color:var(--primary); }
    h2{ margin:0 0 10px 0 } h3{ margin:16px 0 8px 0 }
    .center{ text-align:center } .mb-20{ margin-bottom:20px } .mt-15{ margin-top:15px }
    .card{ background:var(--card); padding:20px; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.06); min-width:320px; transition:transform .2s; margin-bottom:20px; }
    .card:hover{ transform:translateY(-3px) }
    .grid-3{ display:grid; grid-template-columns:2fr 1.2fr auto; gap:10px; align-items:center; }
    table{ width:100%; border-collapse:collapse; margin-top:10px; border-radius:8px; overflow:hidden }
    th,td{ padding:10px; border-bottom:1px solid #eee; text-align:left }
    th{ background:#f1f2fb; color:var(--primary); font-weight:600 }
    input,select{ width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; background:#fff }
    input[type="color"]{ width:40px; height:28px; padding:0; border:none; cursor:pointer }
    .btn{ padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:500; transition:transform .2s, background .2s, opacity .2s; background:#eceff7; }
    .btn:hover{ transform:translateY(-1px) }
    .btn.add{ background:var(--primary); color:#fff } .btn.toggle{ background:var(--secondary); color:#fff }
    .btn.approve{ background:#4caf50; color:#fff } .btn.reject{ background:#f44336; color:#fff } .btn.delete{ background:#9e9e9e; color:#fff }
    .filter-row{ display:flex; gap:10px; align-items:center; margin:6px 0 }
    .calendar{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px }
    .calendar-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px }
    .day{ background:#fff; padding:8px; min-height:110px; border:1px solid #eee; border-radius:8px; font-size:13px; }
    .day strong{ display:block; margin-bottom:4px; color:var(--primary) }
    .leave{ margin-top:6px; padding:6px; border-radius:8px; font-size:12px; color:#fff; }
    .leave .name{ font-weight:700; display:block } .leave .status{ display:block; font-size:11px; opacity:.95 } .leave .dates{ display:block; font-size:10px; opacity:.85 }
    .status{ font-weight:600; padding:3px 8px; border-radius:6px; display:inline-block; text-transform:capitalize }
    .status.pending{ background:#ffecb3; color:#ff9800 } .status.approved{ background:#c8e6c9; color:#2e7d32 } .status.rejected{ background:#ffcdd2; color:#c62828 }
    .emp-days{ font-size:16px; margin:8px 0; color:var(--primary); font-weight:700 }
    .scroll-160{ max-height:160px; overflow-y:auto }
    .leave.pending{ filter:saturate(70%); opacity:.9 }
    .cell-narrow{ white-space:nowrap }
  </style>
</head>
<body>
  <h1>Leave Request System</h1>

  <div class="center mb-20">
    <button class="btn toggle" id="btnAdmin">Админ</button>
  </div>

  <div id="adminPanel" class="card" style="display:none;">
    <h2>Админка</h2>

    <div class="grid-3">
      <input type="text" id="empName" placeholder="Имя сотрудника" />
      <input type="date" id="empStartDate" />
      <button class="btn add" id="btnAddEmp">Добавить сотрудника</button>
    </div>

    <h3>Сотрудники</h3>
    <table id="empTable"></table>

    <h3>Заявки</h3>
    <div class="filter-row">
      Фильтр:
      <select id="reqFilter">
        <option value="all">Все</option>
        <option value="pending">Только pending</option>
        <option value="approved">Только approved</option>
        <option value="rejected">Только rejected</option>
      </select>
    </div>
    <table id="reqTable"></table>
  </div>

  <div class="card">
    <h2>Сотрудник</h2>
    <select id="empSelect"></select>
    <div class="emp-days" id="empDays"></div>

    <label>Дата начала <input type="date" id="fromDate" /></label>
    <label>Дата конца <input type="date" id="toDate" /></label>
    <button class="btn add" id="btnMakeReq">Отправить заявку</button>

    <h3 class="mt-15">Мои заявки</h3>
    <div class="scroll-160">
      <table id="empReqTable"></table>
    </div>
  </div>

  <div class="card">
    <div class="calendar-header">
      <button class="btn" id="btnPrev">← Назад</button>
      <h2 id="calendarTitle"></h2>
      <button class="btn" id="btnNext">Вперёд →</button>
    </div>
    <div class="calendar" id="calendar"></div>
  </div>

  <script>
    // ====== Состояние ======
    let employees = JSON.parse(localStorage.getItem("employees") || "[]");
    let requests  = JSON.parse(localStorage.getItem("requests")  || "[]");

    let adminOpen = false;
    let currentYear  = new Date().getFullYear();
    let currentMonth = new Date().getMonth();

    const COLORS = ["#6C63FF","#FF6584","#4CAF50","#FF9800","#00BCD4","#9C27B0","#795548"];

    // ====== Утилиты ======
    const $ = sel => document.querySelector(sel);
    const MS_DAY = 24*60*60*1000;
    const DAILY_RATE = 1.75 / 30.4375; // ≈ 0.0575 дня/сутки

    function save(){
      localStorage.setItem("employees", JSON.stringify(employees));
      localStorage.setItem("requests",  JSON.stringify(requests));
    }
    function normalizeDate(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function daysBetween(a, b){ return Math.max(0, Math.floor((normalizeDate(b) - normalizeDate(a)) / MS_DAY)); }

    // ====== Автоначисление (ежедневно, пропорционально) ======
    function accrueDaily(){
      const today = normalizeDate(new Date());
      let changed = false;

      employees.forEach(emp=>{
        if (!emp.startDate) emp.startDate = today.toISOString().slice(0,10);
        if (typeof emp.autoAccrued !== "number") emp.autoAccrued = 0;
        if (typeof emp.days !== "number") emp.days = 0;

        const shouldBe = +(daysBetween(new Date(emp.startDate), today) * DAILY_RATE).toFixed(6);
        const delta = +(shouldBe - emp.autoAccrued).toFixed(6);

        if (delta !== 0){
          emp.autoAccrued = +(emp.autoAccrued + delta).toFixed(6);
          emp.days        = +(emp.days + delta).toFixed(6);
          changed = true;
        }
      });

      if (changed) save();
    }

    // ====== Рендер ======
    function render(){
      accrueDaily();
      renderAdminEmployees();
      renderAdminRequests();
      renderEmployeeSelectAndPanel();
      renderCalendar();
    }

    function renderAdminEmployees(){
      const table = $("#empTable");
      table.innerHTML = `
        <tr>
          <th>Имя</th>
          <th>Дней</th>
          <th>Работает с</th>
          <th>Цвет</th>
          <th class="cell-narrow" colspan="2">Действия</th>
        </tr>`;
      employees.forEach(e=>{
        table.innerHTML += `
          <tr>
            <td>${e.name}</td>
            <td>${(e.days||0).toFixed(2)}</td>
            <td>
              <div class="days-input">
                <input type="date" id="startDate_${e.id}" value="${(e.startDate||'').slice(0,10)}" />
                <button class="btn" onclick="saveStartDate(${e.id})">Сохранить</button>
              </div>
              <div style="font-size:12px;opacity:.7">Автоначислено: ${(e.autoAccrued||0).toFixed(2)} дн.</div>
            </td>
            <td><input type="color" value="${e.color||'#999'}" onchange="changeColor(${e.id}, this.value)" /></td>
            <td class="cell-narrow">
              <div class="days-input">
                <input type="number" step="0.25" id="addDaysInput_${e.id}" placeholder="+дни" />
                <button class="btn add" onclick="addDays(${e.id})">OK</button>
              </div>
            </td>
            <td class="cell-narrow"><button class="btn delete" onclick="deleteEmployee(${e.id})">Удалить</button></td>
          </tr>
        `;
      });
    }

    function renderAdminRequests(){
      const sel = $("#reqFilter");
      const filter = sel ? sel.value : "all";
      const table = $("#reqTable");
      table.innerHTML = "<tr><th>Сотрудник</th><th>Даты</th><th>Статус</th><th></th></tr>";
      requests
        .filter(r => filter === "all" ? true : r.status === filter)
        .forEach(r=>{
          table.innerHTML += `
            <tr>
              <td>${r.name}</td>
              <td>${r.from} → ${r.to}</td>
              <td><span class="status ${r.status}">${r.status}</span></td>
              <td>
                ${
                  r.status === "pending"
                  ? `<button class="btn approve" onclick="updateStatus(${r.id},'approved')">✔</button>
                     <button class="btn reject"  onclick="updateStatus(${r.id},'rejected')">✖</button>`
                  : r.status === "approved"
                  ? `<button class="btn toggle"  onclick="updateStatus(${r.id},'pending')">↺ Pending</button>
                     <button class="btn reject"  onclick="updateStatus(${r.id},'rejected')">✖ Отказ</button>`
                  : `<button class="btn toggle" onclick="updateStatus(${r.id},'pending')">↺ Pending</button>`
                }
              </td>
            </tr>
          `;
        });
    }

    function renderEmployeeSelectAndPanel(){
      const sel = $("#empSelect");
      sel.innerHTML = "";
      employees.forEach(e=>{
        const opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = `${e.name} (${(e.days||0).toFixed(2)}д.)`;
        sel.appendChild(opt);
      });
      renderEmployeeRequests();
    }

    function renderEmployeeRequests(){
      const empId = parseInt($("#empSelect").value || "0");
      const emp   = employees.find(e=>e.id===empId);
      $("#empDays").textContent = emp ? `Доступно отпускных дней: ${(emp.days||0).toFixed(2)}` : "";

      const table = $("#empReqTable");
      table.innerHTML = "<tr><th>Даты</th><th>Статус</th></tr>";
      requests.filter(r=>r.empId===empId).forEach(r=>{
        table.innerHTML += `
          <tr>
            <td>${r.from} → ${r.to}</td>
            <td><span class="status ${r.status}">${r.status}</span></td>
          </tr>
        `;
      });
    }

    function renderCalendar(){
      const cal  = $("#calendar");
      const year = currentYear, month = currentMonth;
      cal.innerHTML = "";

      const dim = new Date(year, month+1, 0).getDate();
      const firstDay = new Date(year, month, 1).getDay(); // 0=вс
      $("#calendarTitle").textContent = new Date(year,month).toLocaleString("ru",{month:"long",year:"numeric"});

      let start = (firstDay + 6) % 7; // понедельник первым
      for(let i=0;i<start;i++) cal.innerHTML += `<div class="day"></div>`;

      for(let d=1; d<=dim; d++){
        const dayEl = document.createElement("div");
        dayEl.className = "day";
        dayEl.innerHTML = `<strong>${d}</strong>`;

        const cur = normalizeDate(new Date(year,month,d));

        requests
          .filter(r=>r.status!=="rejected")
          .forEach(r=>{
            const from = normalizeDate(new Date(r.from));
            const to   = normalizeDate(new Date(r.to));
            if(cur>=from && cur<=to){
              const emp   = employees.find(e=>e.id===r.empId);
              const color = emp?.color || "#999";
              const pendingClass = r.status === "pending" ? "pending" : "";
              dayEl.innerHTML += `
                <div class="leave ${pendingClass}" style="background:${color}">
                  <span class="name">${r.name}</span>
                  <span class="status">${r.status}</span>
                  <span class="dates">${r.from} → ${r.to}</span>
                </div>
              `;
            }
          });

        cal.appendChild(dayEl);
      }
    }

    // ====== Действия ======
    function toggleAdmin(){
      if(!adminOpen){
        const pass = prompt("Введите пароль для входа в админку:");
        if(pass === "1234"){ $("#adminPanel").style.display = "block"; adminOpen = true; }
        else{ alert("Неверный пароль!"); }
      }else{
        $("#adminPanel").style.display = "none"; adminOpen = false;
      }
    }

    function addEmployee(){
      const name = ($("#empName").value || "").trim();
      const startDate = $("#empStartDate").value || new Date().toISOString().slice(0,10);
      if(!name) return;

      const color = COLORS[employees.length % COLORS.length];
      employees.push({ id: Date.now(), name, days: 0, startDate, autoAccrued: 0, color });

      $("#empName").value = ""; $("#empStartDate").value = "";
      save(); render();
    }

    function saveStartDate(id){
      const input = document.getElementById("startDate_"+id);
      const newStart = input.value;
      const emp = employees.find(e=>e.id===id);
      if(!emp) return;

      const today = new Date();
      const shouldBe = daysBetween(new Date(newStart), today) * DAILY_RATE;
      const oldAuto  = emp.autoAccrued || 0;
      const delta = +(shouldBe - oldAuto).toFixed(6);

      emp.startDate = newStart;
      emp.autoAccrued = shouldBe;
      emp.days = (emp.days || 0) + delta;

      save(); render();
    }

    function addDays(id){
      const input = document.getElementById("addDaysInput_"+id);
      const val = parseFloat(input.value);
      if(isNaN(val)) return;
      const emp = employees.find(e=>e.id===id);
      emp.days = (emp.days||0) + val;
      input.value = "";
      save(); render();
    }

    function changeColor(id, color){
      const emp = employees.find(e=>e.id===id);
      if(emp){ emp.color = color; save(); render(); }
    }

    function deleteEmployee(id){
      if(!confirm("Удалить сотрудника?")) return;
      employees = employees.filter(e=>e.id!==id);
      requests  = requests.filter(r=>r.empId!==id);
      save(); render();
    }

    function makeRequest(){
      const empId = parseInt($("#empSelect").value || "0");
      const emp   = employees.find(e=>e.id===empId);
      const from  = $("#fromDate").value;
      const to    = $("#toDate").value;

      if(!emp){ alert("Выберите сотрудника"); return; }
      if(!from || !to){ alert("Укажи даты!"); return; }

      const days = (new Date(to) - new Date(from))/(1000*60*60*24) + 1;
      if(days <= 0){ alert("Неверные даты"); return; }
      if(days > (emp.days || 0)){ alert(`У ${emp.name} есть только ${(emp.days||0).toFixed(2)} дней`); return; }

      requests.push({ id: Date.now(), empId, name: emp.name, from, to, days, status: "pending" });
      save(); render();
    }

    function updateStatus(id, status){
      const req = requests.find(r=>r.id===id);
      const emp = employees.find(e=>e.id===req.empId);
      if(!req || !emp) return;

      if(req.status === "approved" && status !== "approved"){
        emp.days = (emp.days||0) + req.days; // вернуть дни
      }
      if(req.status !== "approved" && status === "approved"){
        emp.days = (emp.days||0) - req.days; // списать дни
      }

      req.status = status;
      save(); render();
    }

    // ====== События ======
    document.addEventListener("DOMContentLoaded", ()=>{
      $("#btnAdmin").addEventListener("click", toggleAdmin);
      $("#btnAddEmp").addEventListener("click", addEmployee);
      $("#btnMakeReq").addEventListener("click", makeRequest);
      $("#btnPrev").addEventListener("click", ()=>{ currentMonth--; if(currentMonth<0){currentMonth=11; currentYear--;} renderCalendar(); });
      $("#btnNext").addEventListener("click", ()=>{ currentMonth++; if(currentMonth>11){currentMonth=0; currentYear++;} renderCalendar(); });

      const rf = $("#reqFilter"); if(rf) rf.addEventListener("change", render);
      const es = $("#empSelect"); es.addEventListener("change", renderEmployeeRequests);

      const today = new Date().toISOString().slice(0,10);
      const startInput = document.getElementById("empStartDate");
      if(startInput && !startInput.value) startInput.value = today;

      render();
    });

    // Экспорт для inline-обработчиков
    window.addDays = addDays;
    window.changeColor = changeColor;
    window.deleteEmployee = deleteEmployee;
    window.updateStatus = updateStatus;
    window.saveStartDate = saveStartDate;
  </script>
</body>
</html>
